<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRT Subtitle Translator Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&family=Orbitron:wght@400;700&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      --bg:#0b0c0f; --panel:rgba(18,18,18,.85); --ink:#e7e7e7; --muted:#9aa0a6;
      --neon:#ff6c00; --neonSoft:rgba(255,108,0,.5); --accent:#00ffaa;
      --err:#ff375f; --ok:#00ff7b; --warn:#ffd60a; --border:rgba(255,108,0,.35);
      --radius:12px; --shadow:0 0 18px var(--neonSoft), inset 0 0 0 1px rgba(255,255,255,.03);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Vazirmatn",system-ui,sans-serif;background:var(--bg);color:var(--ink);display:flex;flex-direction:column;min-height:100vh;padding:1rem}
    header{position:sticky;top:0;background:var(--panel);padding:1rem;text-align:center;border-bottom:1px solid var(--border);z-index:10}
    .app{flex:1;width:100%;max-width:1280px;display:grid;grid-template-columns:360px 1fr;gap:1rem;margin:1rem auto}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(10px);box-shadow:var(--shadow);padding:1.5rem;display:flex;flex-direction:column;gap:1rem}
    h1{margin:0;font:700 1.5rem/1.2 "Orbitron",sans-serif;color:var(--neon);text-shadow:0 0 6px var(--neonSoft)}
    .subtitle{margin-top:-0.5rem;color:var(--muted);font-size:.875rem}
    .drop{border:2px dashed var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center;cursor:pointer;min-height:120px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.5rem;transition:border-color .2s,box-shadow .2s}
    .drop:hover,.drop.drag{border-color:var(--neon);box-shadow:0 0 16px var(--neonSoft)}
    .hstack{display:flex;gap:.75rem;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    label{font-size:.875rem;color:var(--muted)}
    select,input[type=text],input[type=color],textarea{width:100%;padding:.75rem;border-radius:8px;border:1px solid var(--border);background:rgba(0,0,0,.35);color:var(--ink);font-family:inherit;font-size:.875rem}
    textarea{min-height:80px;resize:vertical}
    .btn{user-select:none;border:none;border-radius:8px;padding:.75rem 1rem;font:700 .875rem "Orbitron",sans-serif;cursor:pointer;transition:transform .2s,box-shadow .2s}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,var(--neon),#c75800);color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 0 18px var(--neonSoft)}
    .btn-success{background:linear-gradient(135deg,#00a86b,#007b4b);color:#fff}
    .btn-ghost{background:transparent;border:1px dashed var(--border);color:var(--ink)}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .kpi div{padding:.75rem;background:#050607;display:grid;gap:.25rem;text-align:center}
    .kpi .key{font-size:.75rem;color:var(--muted)}
    .kpi .val{font:700 .875rem "Roboto Mono",monospace;color:var(--neon)}
    .progress-bar{height:4px;background:var(--neon);width:0;transition:width .3s ease-out}
    .preview{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .pane{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .pane h3{margin:0;padding:.75rem;border-bottom:1px solid var(--border);font:700 .875rem "Orbitron",sans-serif;color:var(--neon)}
    .pane .body{padding:.75rem;max-height:200px;overflow:auto;direction:ltr;text-align:left;font:.875rem "Roboto Mono",monospace}
    .log{max-height:150px;overflow:auto;border:1px solid var(--border);border-radius:var(--radius);padding:.75rem;background:rgba(0,0,0,.35);font:.75rem/1.5 "Roboto Mono",monospace}
    .log p{margin:0 0 .25rem}
    .ok{color:var(--ok)} .err{color:var(--err)} .info{color:#87cefa} .warn{color:var(--warn)}
    footer{position:sticky;bottom:0;background:var(--panel);padding:1rem;text-align:center;font-size:.75rem;color:var(--muted);border-top:1px solid var(--border)}
    .hidden{display:none}
    .fileName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:ltr;text-align:left}
    @media(max-width:900px){
      .app{grid-template-columns:1fr}
      .preview{grid-template-columns:1fr}
      header,footer{position:static}
    }
  </style>
</head>
<body>
<header>
  <h1>srtDICK☬SHΞNeri</h1>
  <div class="subtitle">دیک‌شینـری اولین مترجم استاتیک ساب‌تایتل</div>
</header>

<main class="app" id="app">
  <section class="card">
    <div class="drop" id="drop">
      <div>فایل یا ZIP را رها کنید یا کلیک کنید</div>
      <div class="badge">SRT / VTT / ASS / ZIP</div>
      <input id="file" type="file" accept=".srt,.vtt,.ass,.zip" multiple class="hidden">
    </div>
    <div class="hstack">
      <input type="text" id="urlInput" placeholder="یا لینک مستقیم فایل زیرنویس" style="flex:1">
      <button class="btn btn-ghost" id="btnLoadUrl">بارگذاری</button>
    </div>
    <div class="grid2">
      <div>
        <label>زبان مبدأ</label>
        <select id="src">
          <option value="auto">تشخیص خودکار</option>
          <option value="en">English</option><option value="de">German</option><option value="fr">French</option>
          <option value="es">Spanish</option><option value="it">Italian</option><option value="ru">Russian</option>
          <option value="ja">Japanese</option><option value="ko">Korean</option><option value="zh">Chinese</option>
          <option value="ar">Arabic</option>
        </select>
      </div>
      <div>
        <label>زبان مقصد</label>
        <select id="tgt">
          <option value="fa">فارسی</option>
          <option value="en">English</option><option value="de">German</option><option value="fr">French</option>
          <option value="es">Spanish</option><option value="it">Italian</option><option value="ru">Russian</option>
          <option value="ja">Japanese</option><option value="ko">Korean</option><option value="zh">Chinese</option>
          <option value="ar">Arabic</option>
        </select>
      </div>
    </div>
    <div class="grid2">
      <button id="modeExclusive" class="btn btn-ghost">Exclusive</button>
      <button id="modeExaggerated" class="btn btn-ghost">Exaggerated</button>
    </div>
    <div id="modeInfoExclusive" class="hidden" style="font-size:.75rem;color:var(--muted)">سریع‌تر / استاندارد / معمولی</div>
    <div id="modeInfoExaggerated" class="hidden" style="font-size:.75rem;color:var(--muted)">کندتر / لهجه سفارشی / یادداشت تولیدکننده</div>
    <div id="advancedSettings" class="card hidden">
      <h3>تنظیمات پیشرفته</h3>
      <label>واژه‌نامه (from => to)</label>
      <textarea id="glossary" placeholder="war => جنگ&#10;AI => هوش مصنوعی"></textarea>
      <div class="grid2">
        <div>
          <label>سبک ترجمه</label>
          <select id="translationStyle">
            <option value="colloquial">محاوره</option>
            <option value="academic">آکادمیک</option>
            <option value="adult">بزرگسال</option>
          </select>
        </div>
        <div class="hstack">
          <input type="checkbox" id="filterProfanity">
          <label for="filterProfanity">فیلتر الفاظ رکیک</label>
        </div>
      </div>
      <input type="text" id="introMsg" placeholder="پیام در ابتدا">
      <input type="text" id="halfMsg" placeholder="پیام در وسط">
      <input type="text" id="endMsg" placeholder="پیام در انتها">
    </div>

    <div class="kpi">
      <div><span class="key">عنوان</span><div id="kTitle" class="val fileName">--</div></div>
      <div><span class="key">فرمت</span><span id="kFmt" class="val">--</span></div>
      <div><span class="key">تعداد</span><span id="kCues" class="val">0</span></div>
      <div><span class="key">کاراکتر</span><span id="kChars" class="val">0</span></div>
      <div><span class="key">وضعیت</span><span id="kStatus" class="val">WAIT</span></div>
      <div><span class="key">پیشرفت</span><span id="kProg" class="val">0%</span></div>
    </div>
    <div id="progressBar" class="progress-bar"></div>

    <div class="hstack">
      <button id="btnTranslate" class="btn btn-primary" disabled>شروع ترجمه</button>
      <button id="btnDownload" class="btn btn-success" disabled>دانلود</button>
    </div>
  </section>

  <section class="card">
    <div class="preview">
      <div class="pane">
        <h3>> اصلی</h3>
        <div class="body" id="pOrig">—</div>
      </div>
      <div class="pane">
        <h3>> ترجمه‌شده</h3>
        <div class="body" id="pTran">—</div>
      </div>
    </div>
    <h3>> لاگ سیستم</h3>
    <div class="log" id="log"></div>
  </section>
</main>

<footer>
  Exclusive ☬SHΞN™ made
</footer>

<script>
// ---------- Utils ----------
const $ = q => document.querySelector(q);
const log = (msg, cls = 'info') => {
  const p = document.createElement('p');
  p.textContent = msg;
  p.className = cls;
  $('#log').appendChild(p);
  $('#log').scrollTop = 1e9;
};
const sleep = ms => new Promise(r => setTimeout(r, ms));
const LANG = { en:'English',fa:'Persian',de:'German',fr:'French',es:'Spanish',it:'Italian',ru:'Russian',ja:'Japanese',ko:'Korean',zh:'Chinese',ar:'Arabic' };
let state = { name:'', ext:'', raw:'', cues:[], kind:'', chars:0, assHeader:'', output:'', outName:'' };

// ---------- فایل و ZIP ----------
const readText = file => new Promise((res,rej)=>{
  const reader = new FileReader();
  reader.onload = e => res(e.target.result);
  reader.onerror = rej;
  reader.readAsText(file);
});
const extractZip = async (file) => {
  const zip = await JSZip.loadAsync(file);
  const subs=[];
  zip.forEach((path, zipEntry) => {
    if (/\.(srt|vtt|ass)$/i.test(path)) subs.push({name: path.split('/').pop(), async text(){ return zipEntry.async('string'); }});
  });
  return Promise.all(subs.map(async s=>({name:s.name, text:await s.text()})));
};

// ---------- Parser ----------
const parseSRT = t => {
  const blocks = t.replace(/\r/g,'').trim().split(/\n\n+/);
  const cues=[]; let chars=0;
  for (const b of blocks){
    const l=b.split('\n');
    if(l.length>=2){ cues.push({type:'srt',idx:l[0].trim(),time:l[1].trim(),text:l.slice(2).join('\n'),raw:b}); chars+=cues.at(-1).text.length;}
  }
  return {cues,chars};
};
const parseVTT = t => {
  const clean=t.replace(/\r/g,'').trim();
  let i=0; const lines=clean.split('\n');
  if(/^WEBVTT/i.test(lines[0])) i= lines[1]===''?2:1;
  const chunks=clean.slice(lines.slice(0,i).join('\n').length).trim().split(/\n\n+/);
  const cues=[]; let chars=0;
  for(const c of chunks){
    const l=c.split('\n');
    const start=/-->/.test(l[0])?0:1;
    cues.push({type:'vtt',id:start?l[0]:null,time:l[start],text:l.slice(start+1).join('\n'),raw:c});
    chars+=cues.at(-1).text.length;
  }
  return {cues,chars};
};
const parseASS = t => {
  const clean=t.replace(/\r/g,'');
  const events=clean.indexOf('[Events]');
  if(events<0) return {cues:[],chars:0,header:clean};
  const head=clean.slice(0,events+8);
  const lines=clean.slice(events+8).split('\n').map(l=>l.trim());
  const fmtLine=lines.find(l=>/^Format:/i.test(l))||'Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text';
  const fields=fmtLine.replace(/^Format:/i,'').split(',').map(s=>s.trim());
  const textIdx=Math.max(fields.findIndex(f=>/^Text$/i.test(f)),fields.length-1);
  const cues=[]; let chars=0;
  for(const l of lines){
    if(/^Dialogue:/i.test(l)){
      const after=l.replace(/^Dialogue:\s*/i,'');
      const parts=after.split(/,(?=(?:[^\{\}]|\{[^\}]*\})*$)/);
      cues.push({type:'ass',meta:parts.slice(0,textIdx),text:parts.slice(textIdx).join(','),raw:l,fmtLine,head});
      chars+=cues.at(-1).text.length;
    }
  }
  return {cues,chars,fmtLine,head};
};

// ---------- Build ----------
const buildSRT=(cues,texts,addBOM)=> (addBOM?'\ufeff':'') + cues.map((c,i)=>`${c.idx}\n${c.time}\n${texts[i]||c.text}`).join('\n\n');
const buildVTT=(orig,cues,texts,addBOM)=>{
  const header=/^WEBVTT/i.test(orig)?orig.split(/\n\n+/)[0]:'WEBVTT';
  return (addBOM?'\ufeff':'') + header+'\n\n'+cues.map((c,i)=>(c.id?c.id+'\n':'')+`${c.time}\n${texts[i]||c.text}`).join('\n\n');
};
const buildASS=(orig,cues,texts,addBOM)=>{
  if(!cues.length) return orig;
  const before=orig.slice(0,orig.indexOf('[Events]')+8);
  const after=orig.slice(orig.indexOf('[Events]')+8).replace(/\r/g,'');
  const lines=after.split('\n');
  const fmtIdx=lines.findIndex(l=>/^Format:/i.test(l));
  const fmtLine=fmtIdx>=0?lines[fmtIdx]:'Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text';
  const fields=fmtLine.replace(/^Format:/i,'').split(',').map(s=>s.trim());
  const textIdx=Math.max(fields.findIndex(f=>/^Text$/i.test(f)),fields.length-1);
  let c=0;
  const rebuilt=lines.map(l=>{
    if(/^Dialogue:/i.test(l)){
      const aft=l.replace(/^Dialogue:\s*/i,'');
      const parts=aft.split(/,(?=(?:[^\{\}]|\{[^\}]*\})*$)/);
      const left=parts.slice(0,textIdx);
      const newText=texts[c]!==undefined?texts[c]:parts.slice(textIdx).join(',');
      c++;
      return 'Dialogue: '+left.join(',')+','+newText;
    }
    return l;
  }).join('\n');
  return (addBOM?'\ufeff':'') + before+rebuilt;
};

// ---------- Glossary ----------
const parseGlossary = txt => {
  const p=[]; if(!txt) return p;
  for(const l of txt.split(/\n+/)){
    const [f,...t]=l.split('=>').map(s=>s.trim());
    if(f && t.length) p.push([f,t.join('=>')]);
  }
  return p;
};
const applyGlossary = (text,pairs,pre=true)=>{
  let out=text;
  pairs.forEach(([f,t],i)=>{
    const token=`§§G${i}§§`;
    const re=new RegExp(f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
    out=pre?out.replace(re,token):out.replace(new RegExp(token,'g'),t);
  });
  return out;
};

// ---------- Translation ----------
const translateLibre = async (txts,src,tgt) => {
  const batch=txts.map(t=>applyGlossary(t.replace(/<(?!\/?(i|b|u)\b)[^>]*>/g,''),parseGlossary($('#glossary').value)));
  const res=await fetch('https://libretranslate.de/translate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({q:batch,source:src==='auto'?'en':src,target:tgt})
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  const tr=Array.isArray(data.translatedText)?data.translatedText:[data.translatedText];
  return tr.map(t=>applyGlossary(t,parseGlossary($('#glossary').value),false));
};
const translatePollinations = async (txts,src,tgt,style,intro,half,end)=>{
  const stylePrompt={colloquial:'محاوره‌ای و روان',academic:'رسمی و دقیق',adult:'بدون سانسور'}[style]||'';
  const prompt=`ترجمه از ${LANG[src]||'انگلیسی'} به ${LANG[tgt]} (${stylePrompt}) و حفظ خط‌بندی:\n${txts.map((t,i)=>`${i+1}. ${t}`).join('\n')}${intro?`\nدر خط 1 اضافه کن: ${intro}`:''}${half?`\nدر خط ${Math.floor(txts.length/2)} اضافه کن: ${half}`:''}${end?`\nدر آخر اضافه کن: ${end}`:''}`;
  const res=await fetch('https://text.pollinations.ai/openai',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:[{role:'user',content:prompt}]})
  });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  const raw=data.choices?.[0]?.message?.content||'';
  return raw.split(/\n+/).map(l=>l.replace(/^\s*\d+\.?\s*/,'').trim()).filter(l=>l).slice(0,txts.length);
};

// ---------- State ----------
const resetUI=()=>{
  state={name:'',ext:'',raw:'',cues:[],kind:'',chars:0,assHeader:'',output:'',outName:''};
  $('#kTitle').textContent='--'; $('#kFmt').textContent='--'; $('#kCues').textContent='0'; $('#kChars').textContent='0';
  $('#kStatus').textContent='WAIT'; $('#kProg').textContent='0%'; $('#progressBar').style.width='0';
  $('#pOrig').textContent='—'; $('#pTran').textContent='—';
  $('#btnTranslate').disabled=true; $('#btnDownload').disabled=true;
  $('#log').innerHTML='';
};

// ---------- DropZone ----------
const drop=$('#drop'),fileInput=$('#file');
['click'].forEach(e=>drop.addEventListener(e,()=>fileInput.click()));
['dragenter','dragover'].forEach(e=>drop.addEventListener(e, ev=>{ev.preventDefault();drop.classList.add('drag')}));
['dragleave','drop'].forEach(e=>drop.addEventListener(e, ev=>{ev.preventDefault();drop.classList.remove('drag')}));
drop.addEventListener('drop', ev=>{
  const files=ev.dataTransfer.files;
  if(files.length) handleFiles(files[0]);
});
fileInput.addEventListener('change', ev=>{
  if(ev.target.files.length) handleFiles(ev.target.files[0]);
});

const handleFiles = async (file) => {
  if(file.size>10*1024*1024){log('[ERR] حداکثر ۱۰ مگابایت','err');return;}
  resetUI();
  if(file.type==='application/zip' || /\.zip$/i.test(file.name)){
    const subs=await extractZip(file);
    if(!subs.length){log('[ERR] ZIP بدون زیرنویس معتبر','err');return;}
    const f=subs[0];
    analyze(f.text,f.name);
  }else{
    const text=await readText(file);
    analyze(text,file.name);
  }
};

const analyze=(text,name)=>{
  const ext=name.split('.').pop().toLowerCase();
  let parsed;
  if(ext==='srt') parsed=parseSRT(text);
  else if(ext==='vtt') parsed=parseVTT(text);
  else if(ext==='ass') parsed=parseASS(text);
  else{log('[ERR] فرمت پشتیبانی نمی‌شود','err');return;}
  state={name,ext,raw:text,cues:parsed.cues,kind:ext,chars:parsed.chars,assHeader:parsed.head||'',output:'',outName:''};
  $('#kTitle').textContent=name.replace(/\.[^.]+$/,'');
  $('#kFmt').textContent=ext.toUpperCase();
  $('#kCues').textContent=state.cues.length;
  $('#kChars').textContent=state.chars;
  $('#kStatus').textContent='READY';
  if(state.cues[0]) $('#pOrig').textContent=state.cues[0].text;
  log(`[FILE] ${name} بارگذاری شد (${state.cues.length} cue)`,'ok');
  $('#btnTranslate').disabled=false;
};

// ---------- لینک مستقیم ----------
$('#btnLoadUrl').addEventListener('click',async()=>{
  const url=$('#urlInput').value.trim();
  if(!url){log('[ERR] لینک خالی است','err');return;}
  try{
    const u=new URL(url);
    if(!/\.(srt|vtt|ass)$/i.test(u.pathname)){log('[ERR] پسوند لینک باید srt/vtt/ass باشد','err');return;}
    log('[URL] در حال دریافت...','info');
    const res=await fetch(url,{mode:'cors'});
    if(!res.ok) throw new Error(res.statusText);
    const text=await res.text();
    const name=u.pathname.split('/').pop();
    analyze(text,name);
  }catch(e){log('[ERR] '+e.message,'err');}
});

// ---------- حالت ترجمه ----------
let selectedMode=null;
$('#modeExclusive').onclick=()=>{
  selectedMode='exclusive';
  $('#modeExclusive').className='btn btn-primary';
  $('#modeExaggerated').className='btn btn-ghost';
  $('#modeInfoExclusive').classList.remove('hidden');
  $('#modeInfoExaggerated').classList.add('hidden');
  $('#advancedSettings').classList.add('hidden');
  $('#btnTranslate').disabled=!state.cues.length;
};
$('#modeExaggerated').onclick=()=>{
  selectedMode='exaggerated';
  $('#modeExaggerated').className='btn btn-primary';
  $('#modeExclusive').className='btn btn-ghost';
  $('#modeInfoExaggerated').classList.remove('hidden');
  $('#modeInfoExclusive').classList.add('hidden');
  $('#advancedSettings').classList.remove('hidden');
  $('#btnTranslate').disabled=!state.cues.length;
};

// ---------- ترجمه با Progress ----------
$('#btnTranslate').onclick=async()=>{
  if(!selectedMode||!state.cues.length)return;
  $('#btnTranslate').disabled=true;
  $('#btnDownload').disabled=true;
  log(`[TRANSLATE] شروع (${selectedMode})`,'info');
  try{
    const src=$('#src').value,tgt=$('#tgt').value;
    const batchSize=5,charLimit=42,cpsLimit=20,addBOM=true;
    const texts=state.cues.map(c=>c.text);
    const durations=state.cues.map((c,i)=>{
      const next=state.cues[i+1];
      const end=next?next.time.split(' --> ')[0]:c.time.split(' --> ')[1];
      const [sh,sm,ss,sms]=c.time.split(' --> ')[0].split(/[:,]/).map(Number);
      const [eh,em,es,ems]=end.split(/[:,]/).map(Number);
      const ms=(eh*3600+em*60+es)*1000+ems-(sh*3600+sm*60+ss)*1000-sms;
      return Math.max(ms,0);
    });
    let translated=[];
    const total=texts.length;
    let done=0;
    if(selectedMode==='exclusive'){
      for(let i=0;i<total;i+=batchSize){
        const batch=texts.slice(i,i+batchSize);
        const res=await translateLibre(batch,src,tgt);
        translated.push(...res);
        done+=batch.length;
        const prog=Math.round((done/total)*100);
        $('#kProg').textContent=prog+'%';
        $('#progressBar').style.width=prog+'%';
        $('#kStatus').textContent='TRANSLATING';
        log(`[PROGRESS] ${done}/${total} ترجمه شد (${prog}%)`,'info');
        await sleep(500);
      }
    }else{
      const style=$('#translationStyle').value,intro=$('#introMsg').value,half=$('#halfMsg').value,end=$('#endMsg').value;
      translated=await translatePollinations(texts,src,tgt,style,intro,half,end);
      if($('#filterProfanity').checked){
        translated=translated.map(t=>t.replace(/\b(کیر|کس|مادرجنده)\b/gi,'***'));
      }
      $('#progressBar').style.width='100%';
      $('#kProg').textContent='100%';
      log('[PROGRESS] ترجمه کامل شد','ok');
    }
    // CPS و linebreak
    translated=translated.map((t,i)=>{
      const dur=durations[i]/1000;
      const chars=t.replace(/\s+/g,' ').trim().length;
      if(dur&&(chars/dur)>cpsLimit){
        const maxLen=Math.max(12,Math.floor(chars*(cpsLimit/(chars/dur))));
        return t.replace(/.{1,maxLen}(\s|$)/g,'$&\n').trim();
      }
      return t;
    });
    if(translated[0]) $('#pTran').textContent=translated[0];
    let output;
    if(state.kind==='srt')output=buildSRT(state.cues,translated,addBOM);
    else if(state.kind==='vtt')output=buildVTT(state.raw,state.cues,translated,addBOM);
    else if(state.kind==='ass')output=buildASS(state.raw,state.cues,translated,addBOM);
    state.output=output;
    state.outName=state.name.replace(/\.[^.]+$/,'')+'_translated.'+state.ext;
    $('#kStatus').textContent='DONE';
    $('#btnDownload').disabled=false;
    log('[SUCCESS] ترجمه آماده دانلود است','ok');
  }catch(e){
    log('[ERR] '+e.message,'err');
    $('#kStatus').textContent='ERROR';
    $('#progressBar').style.width='0';
  }
  $('#btnTranslate').disabled=false;
};

// ---------- دانلود ----------
$('#btnDownload').onclick=()=>{
  const blob=new Blob([state.output],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=state.outName;
  a.click();
  URL.revokeObjectURL(url);
};

// ---------- init ----------
resetUI();
</script>
</body>
</html>
